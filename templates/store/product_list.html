{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if active_category %}
        {{ active_category.name }}
    {% else %}
        Products
    {% endif %}
{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'home' %}">Home</a>
            </li>

            <li class="breadcrumb-item {% if not active_category %}active{% endif %}">
                {% if active_category %}
                    <a href="{% url 'product_list' %}">Products</a>
                {% else %}
                    Products
                {% endif %}
            </li>

            {% if active_category %}
                <li class="breadcrumb-item active" aria-current="page">
                    {{ active_category.name }}
                </li>
            {% endif %}
        </ol>
    </nav>

    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm p-3">
                <h5 class="fw-700 mb-3">
                    <i class="fas fa-filter me-2"></i>Filters
                </h5>

                <form method="get" action="{% url 'product_list' %}">

                    <!-- Category Filter -->
                    <div class="mb-3">
                        <h6 class="fw-600 small text-uppercase text-muted mb-2">
                            Category
                        </h6>

                        <div class="form-check mb-1">
                            <input class="form-check-input"
                                   type="radio"
                                   name="category"
                                   id="cat-all"
                                   value=""
                                   {% if not current_category %}checked{% endif %}>
                            <label class="form-check-label small" for="cat-all">
                                All Categories
                            </label>
                        </div>

                        {% for cat in categories %}
                        <div class="form-check mb-1">
                            <input class="form-check-input"
                                   type="radio"
                                   name="category"
                                   id="cat-{{ cat.slug }}"
                                   value="{{ cat.slug }}"
                                   {% if current_category == cat.slug %}checked{% endif %}>

                            <label class="form-check-label small" for="cat-{{ cat.slug }}">
                                {{ cat.name }}
                                <span class="text-muted">({{ cat.product_count }})</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Price Range -->
                    <div class="mb-3">
                        <h6 class="fw-600 small text-uppercase text-muted mb-2">
                            Price Range
                        </h6>

                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number"
                                       class="form-control form-control-sm"
                                       name="min_price"
                                       placeholder="Min ₹"
                                       value="{{ min_price }}">
                            </div>
                            <div class="col-6">
                                <input type="number"
                                       class="form-control form-control-sm"
                                       name="max_price"
                                       placeholder="Max ₹"
                                       value="{{ max_price }}">
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="sort" value="{{ sort }}">

                    <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="fas fa-check me-1"></i>Apply Filters
                    </button>

                    <a href="{% url 'product_list' %}"
                       class="btn btn-outline-secondary btn-sm w-100">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>

                </form>
            </div>
        </div>

        <!-- PRODUCT GRID -->
        <div class="col-md-9">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">

                <h5 class="fw-600 mb-0">
                    {% if active_category %}
                        {{ active_category.name }}
                    {% else %}
                        All Products
                    {% endif %}

                    <small class="text-muted fw-400">
                        ({{ page_obj.paginator.count }}
                        product{{ page_obj.paginator.count|pluralize }})
                    </small>
                </h5>

                <div class="d-flex align-items-center gap-2">
                    <label class="small text-muted mb-0">Sort by:</label>

                    <select class="form-select form-select-sm"
                            id="sort-select"
                            style="width: auto;"
                            onchange="updateSort(this.value)">

                        <option value="newest"
                                {% if sort == 'newest' %}selected{% endif %}>
                            Newest
                        </option>

                        <option value="price_asc"
                                {% if sort == 'price_asc' %}selected{% endif %}>
                            Price: Low → High
                        </option>

                        <option value="price_desc"
                                {% if sort == 'price_desc' %}selected{% endif %}>
                            Price: High → Low
                        </option>

                        <option value="name"
                                {% if sort == 'name' %}selected{% endif %}>
                            Name: A–Z
                        </option>

                        <option value="rating"
                                {% if sort == 'rating' %}selected{% endif %}>
                            Avg Rating
                        </option>
                    </select>
                </div>
            </div>

            <!-- Product Cards -->
            <div class="row row-cols-2 row-cols-md-3 g-3">

                {% for product in page_obj %}
                <div class="col">
                    <div class="card product-card h-100">

                        <div class="product-img-wrapper">

                            {% if product.discount_percentage > 0 %}
                                <span class="discount-badge">
                                    -{{ product.discount_percentage }}%
                                </span>
                            {% endif %}

                            {% if user.is_authenticated %}
                            <button class="wishlist-btn"
                                    data-toggle-url="{% url 'toggle_wishlist' product.id %}">
                                <i class="{% if product.id in wishlist_ids %}fas{% else %}far{% endif %} fa-heart"
                                   style="color:
                                   {% if product.id in wishlist_ids %}
                                       #dc3545
                                   {% else %}
                                       #aaa
                                   {% endif %};">
                                </i>
                            </button>
                            {% endif %}

                            <a href="{{ product.get_absolute_url }}">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}"
                                         class="product-img"
                                         alt="{{ product.name }}">
                                {% else %}
                                    <img src="https://via.placeholder.com/400x400"
                                         class="product-img"
                                         alt="{{ product.name }}">
                                {% endif %}
                            </a>

                            {% if not product.is_in_stock %}
                                <div class="out-of-stock-overlay">
                                    Out of Stock
                                </div>
                            {% endif %}
                        </div>

                        <div class="card-body d-flex flex-column">

                            <span class="product-category">
                                {{ product.category.name }}
                            </span>

                            <a href="{{ product.get_absolute_url }}"
                               class="text-decoration-none">
                                <h6 class="product-title">
                                    {{ product.name|truncatewords:8 }}
                                </h6>
                            </a>

                            <div class="stars mb-1">
                                {% with product.average_rating as rating %}
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star stars-empty"></i>
                                        {% endif %}
                                    {% endfor %}
                                {% endwith %}
                                <small class="text-muted">
                                    ({{ product.review_count }})
                                </small>
                            </div>

                            <div class="mt-auto">
                                <span class="price-current">
                                    ₹{{ product.effective_price }}
                                </span>

                                {% if product.discount_price %}
                                    <span class="price-original">
                                        ₹{{ product.price }}
                                    </span>
                                {% endif %}
                            </div>

                            <form method="post"
                                  action="{% url 'add_to_cart' product.id %}"
                                  class="mt-2">
                                {% csrf_token %}
                                <button type="submit"
                                        class="btn btn-primary btn-sm w-100"
                                        {% if not product.is_in_stock %}disabled{% endif %}>
                                    <i class="fas fa-cart-plus me-1"></i>
                                    Add to Cart
                                </button>
                            </form>

                        </div>
                    </div>
                </div>

                {% empty %}
                <div class="col-12 text-center py-5">
                    <h5 class="text-muted">No products found</h5>
                </div>
                {% endfor %}

            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateSort(value) {
    const url = new URL(window.location);
    url.searchParams.set('sort', value);
    url.searchParams.delete('page');
    window.location.href = url.toString();
}
</script>
{% endblock %}