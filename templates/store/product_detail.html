{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- ══════════════════════════════════════════════════════ -->
    <!-- ROW 1: PRODUCT MAIN                                    -->
    <!-- ══════════════════════════════════════════════════════ -->
    <div class="row g-4 mb-5">
        <!-- LEFT: Product Image -->
        <div class="col-md-5">
            <div class="position-relative">
                {% if product.discount_percentage > 0 %}
                <span class="discount-badge" style="font-size: 0.9rem; padding: 5px 14px;">
                    -{{ product.discount_percentage }}% OFF
                </span>
                {% endif %}
                {% if user.is_authenticated %}
                <button class="wishlist-btn {% if is_in_wishlist %}active{% endif %}"
                    data-toggle-url="{% url 'toggle_wishlist' product.id %}"
                    title="{% if is_in_wishlist %}Remove from{% else %}Add to{% endif %} Wishlist"
                    style="top: 15px; right: 15px; width: 44px; height: 44px;">
                    <i class="{% if is_in_wishlist %}fas{% else %}far{% endif %} fa-heart fa-lg"
                        style="color: {% if is_in_wishlist %}#dc3545{% else %}#aaa{% endif %};"></i>
                </button>
                {% endif %}
                {% if product.image %}
                <img src="{{ product.image.url }}" class="w-100 rounded-3 product-main-img" alt="{{ product.name }}"
                    style="max-height: 450px; object-fit: cover;">
                {% else %}
                <img src="https://via.placeholder.com/600x450/6C63FF/FFF?text={{ product.name|truncatewords:3 }}"
                    class="w-100 rounded-3" alt="{{ product.name }}" style="max-height: 450px; object-fit: cover;">
                {% endif %}
            </div>
        </div>

        <!-- RIGHT: Product Info -->
        <div class="col-md-7">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ product.category.get_absolute_url }}">{{
                            product.category.name }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ product.name|truncatewords:5 }}</li>
                </ol>
            </nav>

            <small class="text-muted text-uppercase">{{ product.category.name }}</small>
            <h2 class="fw-bold mt-1 mb-2">{{ product.name }}</h2>

            <!-- Star Rating -->
            <div class="d-flex align-items-center mb-3">
                <div class="stars me-2">
                    {% for i in "12345" %}
                    {% if forloop.counter <= avg_rating %} <i class="fas fa-star"></i>
                        {% elif forloop.counter <= avg_rating|add:"0.5" %} <i class="fas fa-star-half-alt"></i>
                            {% else %}
                            <i class="far fa-star stars-empty"></i>
                            {% endif %}
                            {% endfor %}
                </div>
                <span class="text-muted small">{{ avg_rating }} ({{ product.review_count }} review{{
                    product.review_count|pluralize }})</span>
            </div>

            <!-- Price Block -->
            <div class="mb-3">
                <span class="h3 text-primary fw-bold">₹{{ product.effective_price }}</span>
                {% if product.discount_price %}
                <span class="text-muted text-decoration-line-through ms-2 fs-5">₹{{ product.price }}</span>
                <span class="badge bg-danger ms-2">-{{ product.discount_percentage }}% OFF</span>
                {% endif %}
            </div>

            <!-- Stock Badge -->
            <div class="mb-3">
                {% if product.is_in_stock %}
                <span class="badge bg-success-subtle text-success px-3 py-2">
                    <i class="fas fa-check-circle me-1"></i>In Stock ({{ product.stock }} left)
                </span>
                {% else %}
                <span class="badge bg-danger-subtle text-danger px-3 py-2">
                    <i class="fas fa-times-circle me-1"></i>Out of Stock
                </span>
                {% endif %}
            </div>

            <hr>

            <!-- Description -->
            <div class="card bg-light border-0 p-3 rounded mb-3">
                <p class="mb-0">{{ product.description }}</p>
            </div>

            <!-- Add to Cart Form -->
            {% if product.is_in_stock %}
            <form class="add-to-cart-form" method="post" action="{% url 'add_to_cart' product.id %}">
                {% csrf_token %}
                <div class="d-flex gap-3 align-items-center mb-3 flex-wrap">
                    <div class="d-flex align-items-center border rounded">
                        <button type="button" class="btn btn-sm qty-btn qty-decrease" id="qty-decrease">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}"
                            class="form-control border-0 qty-input" id="qty-input"
                            style="width: 60px; text-align: center;">
                        <button type="button" class="btn btn-sm qty-btn qty-increase" id="qty-increase"
                            data-max="{{ product.stock }}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="fas fa-cart-plus me-2"></i>Add to Cart
                    </button>
                </div>
            </form>
            {% else %}
            <button class="btn btn-secondary btn-lg px-5 mb-3" disabled>
                <i class="fas fa-ban me-2"></i>Out of Stock
            </button>
            {% endif %}

            {% if user.is_authenticated %}
            <button class="wishlist-btn-text btn btn-outline-danger {% if is_in_wishlist %}active{% endif %}"
                data-toggle-url="{% url 'toggle_wishlist' product.id %}">
                <i class="{% if is_in_wishlist %}fas{% else %}far{% endif %} fa-heart me-1"></i>
                {% if is_in_wishlist %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}
            </button>
            {% endif %}

            <!-- Product Meta -->
            <div class="mt-4">
                <table class="table table-sm table-borderless small text-muted">
                    <tr>
                        <td class="fw-600" style="width:120px;">SKU</td>
                        <td>SHOP-{{ product.id|stringformat:"05d" }}</td>
                    </tr>
                    <tr>
                        <td class="fw-600">Category</td>
                        <td><a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a></td>
                    </tr>
                    <tr>
                        <td class="fw-600">Availability</td>
                        <td>{% if product.is_in_stock %}In Stock{% else %}Out of Stock{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="fw-600">Updated</td>
                        <td>{{ product.updated_at|date:"M d, Y" }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════ -->
    <!-- ROW 2: REVIEWS SECTION                                 -->
    <!-- ══════════════════════════════════════════════════════ -->
    <div class="row g-4 mb-5">
        <!-- Rating Summary -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm p-4 text-center">
                <h5 class="fw-700 mb-3">Customer Reviews</h5>
                <div class="display-4 fw-800 text-primary">{{ avg_rating }}</div>
                <div class="stars fs-5 my-2">
                    {% for i in "12345" %}
                    {% if forloop.counter <= avg_rating %} <i class="fas fa-star"></i>
                        {% else %}
                        <i class="far fa-star stars-empty"></i>
                        {% endif %}
                        {% endfor %}
                </div>
                <p class="text-muted small">Based on {{ product.review_count }} review{{ product.review_count|pluralize
                    }}</p>

                <hr>
                <!-- Star Distribution Bars -->
                {% for star, count in rating_distribution.items %}
                <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="small fw-600" style="width: 50px;">{{ star }} <i class="fas fa-star text-warning"
                            style="font-size: 0.7rem;"></i></span>
                    <div class="progress flex-grow-1" style="height: 8px;">
                        <div class="progress-bar bg-warning" role="progressbar"
                            style="width: {% widthratio count product.review_count 100 %}%"></div>
                    </div>
                    <span class="small text-muted" style="width: 25px;">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Review List + Add Review -->
        <div class="col-md-8">
            <h5 class="fw-700 mb-3">Reviews ({{ product.review_count }})</h5>

            {% for review in reviews %}
            <div class="card border-0 shadow-sm mb-3 p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center gap-2">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                            style="width: 40px; height: 40px; font-weight: 600;">
                            {{ review.user.first_name.0|default:review.user.username.0|upper }}
                        </div>
                        <div>
                            <strong>{{ review.user.get_full_name|default:review.user.username }}</strong>
                            <div class="stars" style="font-size: 0.75rem;">
                                {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %} <i class="fas fa-star"></i>
                                    {% else %}
                                    <i class="far fa-star stars-empty"></i>
                                    {% endif %}
                                    {% endfor %}
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                </div>
                <h6 class="fw-600 mt-2 mb-1">{{ review.title }}</h6>
                <p class="text-muted mb-0 small">{{ review.body }}</p>
            </div>
            {% empty %}
            <div class="card border-0 shadow-sm p-4 text-center">
                <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">No reviews yet. Be the first to review this product!</p>
            </div>
            {% endfor %}

            <!-- Add Review Form -->
            {% if user.is_authenticated and not user_review %}
            <div class="card border-0 shadow-sm p-4 mt-3">
                <h6 class="fw-700 mb-3"><i class="fas fa-pen me-2"></i>Write a Review</h6>
                <form method="post" action="{% url 'add_review' product.slug %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label fw-600 small">Rating</label>
                        <div class="d-flex gap-3">
                            {% for value, label in review_form.fields.rating.choices %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="rating" id="rating-{{ value }}"
                                    value="{{ value }}">
                                <label class="form-check-label small" for="rating-{{ value }}">
                                    {{ value }} <i class="fas fa-star text-warning"></i>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-600 small">Title</label>
                        {{ review_form.title }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-600 small">Your Review</label>
                        {{ review_form.body }}
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Submit Review
                    </button>
                </form>
            </div>
            {% elif user.is_authenticated and user_review %}
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>You've already reviewed this product.
            </div>
            {% else %}
            <div class="alert alert-light mt-3">
                <a href="{% url 'login' %}?next={{ request.path }}" class="text-primary fw-600">Login</a> to write a
                review.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ══════════════════════════════════════════════════════ -->
    <!-- ROW 3: RELATED PRODUCTS                                -->
    <!-- ══════════════════════════════════════════════════════ -->
    {% if related_products %}
    <div class="mb-5">
        <h4 class="section-title mb-4">You Might Also Like</h4>
        <div class="row g-3">
            {% for product in related_products %}
            <div class="col-6 col-md-3">
                <div class="card product-card h-100">
                    <div class="product-img-wrapper">
                        {% if product.discount_percentage > 0 %}
                        <span class="discount-badge">-{{ product.discount_percentage }}%</span>
                        {% endif %}
                        <a href="{{ product.get_absolute_url }}">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" class="product-img" alt="{{ product.name }}">
                            {% else %}
                            <img src="https://via.placeholder.com/400x400/6C63FF/FFF?text={{ product.name|truncatewords:2 }}"
                                class="product-img" alt="{{ product.name }}">
                            {% endif %}
                        </a>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <span class="product-category">{{ product.category.name }}</span>
                        <a href="{{ product.get_absolute_url }}" class="text-decoration-none">
                            <h6 class="product-title">{{ product.name|truncatewords:6 }}</h6>
                        </a>
                        <div class="mt-auto">
                            <span class="price-current">₹{{ product.effective_price }}</span>
                            {% if product.discount_price %}
                            <span class="price-original">₹{{ product.price }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const qtyInput = document.getElementById('qty-input');
        const decreaseBtn = document.getElementById('qty-decrease');
        const increaseBtn = document.getElementById('qty-increase');

        if (decreaseBtn && increaseBtn && qtyInput) {
            decreaseBtn.addEventListener('click', function () {
                let val = parseInt(qtyInput.value) || 1;
                if (val > 1) qtyInput.value = val - 1;
            });
            increaseBtn.addEventListener('click', function () {
                let val = parseInt(qtyInput.value) || 1;
                const max = parseInt(increaseBtn.dataset.max) || 99;
                if (val < max) qtyInput.value = val + 1;
            });
        }

        // Wishlist text button
        const wishlistTextBtn = document.querySelector('.wishlist-btn-text');
        if (wishlistTextBtn) {
            wishlistTextBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const url = this.dataset.toggleUrl;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            const icon = this.querySelector('i');
                            if (data.action === 'added') {
                                icon.classList.replace('far', 'fas');
                                this.innerHTML = '<i class="fas fa-heart me-1"></i>Remove from Wishlist';
                            } else {
                                this.innerHTML = '<i class="far fa-heart me-1"></i>Add to Wishlist';
                            }
                            showToast(data.message, 'success');
                        }
                    });
            });
        }
    });
</script>
{% endblock %}